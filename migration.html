<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-migration">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<title data-rh="true">Migration from RKE1 to RKE2 | RKE 2</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://rancher.github.io//rke2-docs/migration"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Migration from RKE1 to RKE2 | RKE 2"><meta data-rh="true" name="description" content="In order to migrate from Rancher Kubernetes Engine (RKE1) to RKE2, you need two things:"><meta data-rh="true" property="og:description" content="In order to migrate from Rancher Kubernetes Engine (RKE1) to RKE2, you need two things:"><link data-rh="true" rel="icon" href="/rke2-docs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://rancher.github.io//rke2-docs/migration"><link data-rh="true" rel="alternate" href="https://rancher.github.io//rke2-docs/migration" hreflang="en"><link data-rh="true" rel="alternate" href="https://rancher.github.io//rke2-docs/migration" hreflang="x-default"><link rel="stylesheet" href="/rke2-docs/assets/css/styles.a104b84c.css">
<link rel="preload" href="/rke2-docs/assets/js/runtime~main.cc8464e9.js" as="script">
<link rel="preload" href="/rke2-docs/assets/js/main.a8254415.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/rke2-docs/"><div class="navbar__logo"><img src="/rke2-docs/img/logo-horizontal-rke2.svg" alt="logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/rke2-docs/img/logo-horizontal-rke2.svg" alt="logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link navbar__docs" href="/rke2-docs/">Docs</a><a href="https://github.com/rancher/rke2" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__github btn btn-secondary icon-github">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><main class="docMainContainer_gTbr docMainContainerEnhanced_Uz_u"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Migration from RKE1 to RKE2</h1><p>In order to migrate from Rancher Kubernetes Engine (RKE1) to RKE2, you need two things:</p><ul><li>ETCD data directory</li><li>Cluster CA certificates</li></ul><p>Both can be found when you take a RKE1 snapshot, as the RKE1 snapshot archive contains two things: an etcd snapshot, and <code>.rkestate</code> of your cluster.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introducing-migration-agent">Introducing Migration Agent<a class="hash-link" href="#introducing-migration-agent" title="Direct link to heading">​</a></h2><p>migration-agent is a tool that lays the groundwork for RKE1 nodes to move to RKE2 nodes. It accomplishes this in two main steps:</p><ul><li>Restore the etcd snapshot on etcd nodes to the RKE2 etcd db data directory.</li><li>Copy the CA certs and service account token key from <code>.rkestate</code> file to RKE2 data directory.</li></ul><p>This tool runs on RKE1 nodes before running RKE2.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="usage">Usage<a class="hash-link" href="#usage" title="Direct link to heading">​</a></h3><ol><li><p>To run the migration you need to take a snapshot first on rke1 nodes:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">rke etcd snapshot-save --s3 --name rke1snapshot --access-key &lt;access-key&gt; --secret-key &lt;secret-key&gt; --region &lt;region&gt; --folder &lt;folder&gt; --bucket-name &lt;bucket name&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><p>For more information, please refer to the RKE1 <a href="https://rancher.com/docs/rke/latest/en/etcd-snapshots/one-time-snapshots/" target="_blank" rel="noopener noreferrer">official documentation</a></p><ol start="2"><li><p>Now you can either run migration agent directly on the node, or use the following <a href="https://github.com/rancher/migration-agent/blob/master/deploy/daemonset.yaml" target="_blank" rel="noopener noreferrer">manifest</a> to deploy migration-agent as a daemonset on the RKE1 cluster. Before you apply the manifest file, you need to edit the file to include the information about the s3 snapshot of RKE1:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">command:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">- &quot;sh&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">- &quot;-c&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">- &quot;migration-agent --s3-region &lt;region&gt; --s3-bucket &lt;s3 bucket&gt; --s3-folder &lt;s3 folder&gt; --s3-access-key &lt;access-key&gt; --s3-secret-key &lt;secret-key&gt;  --snapshot rke1db.zip &amp;&amp; sleep 9223372036854775807&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>After running the tool you should see the following paths have been created on control-plane and etcd nodes:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/etc/rancher/rke2/config.yaml.d/10-migration.yaml</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/var/lib/rancher/rke2/server/</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/var/lib/rancher/rke2/server/db/</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/var/lib/rancher/rke2/server/manifests/</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/var/lib/rancher/rke2/server/tls/</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/var/lib/rancher/rke2/server/cred</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>The next step is stop docker containers of rke1:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">systemctl disable docker</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">systemctl stop docker</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>The last step is to install and run rke2 server or agent depend on the type of the node:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">curl -sfL https://get.rke2.io | sh -</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">systemctl start rke2-server</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">systemctl enable rke2-server</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cluster-configuration">Cluster Configuration<a class="hash-link" href="#cluster-configuration" title="Direct link to heading">​</a></h3><p>One of the functions of the migration-agent is to copy the cluster configuration from the rkestate file to <code>/etc/rancher/rke2/config.yaml.d/10-migration.yaml</code>, this includes:</p><ul><li>Cluster CIDR</li><li>Service CIDR</li><li>Service Node Port Range</li><li>Cluster DNS</li><li>Cluster Domain</li><li>Extra API Args</li><li>Extra Scheduler Args</li><li>Extra Controller Manager Args</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="addons-migration">Addons Migration<a class="hash-link" href="#addons-migration" title="Direct link to heading">​</a></h3><p>RKE2 deploys addons as helm charts, so migration-agent creates a manifest that deletes the old RKE1 addons and let RKE2 deploys addons as Helm charts.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cluster-addons-configuration-migration">Cluster Addons Configuration Migration<a class="hash-link" href="#cluster-addons-configuration-migration" title="Direct link to heading">​</a></h3><p>One of the migration-agent features is migrating all configuration for the cluster addons to rke2, this includes:</p><ul><li>CoreDNS configuration</li><li>Metrics-Server configuration</li><li>Ingress nginx configuration </li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="coredns-configuration">CoreDNS Configuration<a class="hash-link" href="#coredns-configuration" title="Direct link to heading">​</a></h4><p>RKE1 adds several configuration options for CoreDNS, migration-agent makes sure that these configs are migrated to a HelmchartConfig which will be used to configure the CoreDNS helmChart:</p><table><thead><tr><th>CoreDNS Optinos</th></tr></thead><tbody><tr><td>PriorityClassName</td></tr><tr><td>NodeSelector</td></tr><tr><td>RollingUpdate</td></tr><tr><td>Tolerations</td></tr><tr><td>AutoScalerConfig.Enabled</td></tr><tr><td>AutoScalerConfig.PriorityClassName</td></tr><tr><td>AutoScalerConfig.Min</td></tr><tr><td>AutoScalerConfig.Max</td></tr><tr><td>AutoScalerConfig.CoresPerReplica</td></tr><tr><td>utoScalerConfig.NodesPerReplica</td></tr><tr><td>AutoScalerConfig.PreventSinglePointFailure</td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_LWe7" id="metrics-server-configuration">Metrics Server Configuration<a class="hash-link" href="#metrics-server-configuration" title="Direct link to heading">​</a></h4><p>migration-agent also does the same for Metrics Server</p><table><thead><tr><th align="center">Metrics Server Options</th></tr></thead><tbody><tr><td align="center">PriorityClassName</td></tr><tr><td align="center">NodeSelector</td></tr><tr><td align="center">RBAC</td></tr><tr><td align="center">Tolerations</td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_LWe7" id="ingress-nginx-configuration">Ingress Nginx Configuration<a class="hash-link" href="#ingress-nginx-configuration" title="Direct link to heading">​</a></h4><table><thead><tr><th align="center">Nginx Ingress Config</th></tr></thead><tbody><tr><td align="center">ConfigMap</td></tr><tr><td align="center">NodeSelector</td></tr><tr><td align="center">ExtraArgs</td></tr><tr><td align="center">ExtraEnvs</td></tr><tr><td align="center">ExtraVolumes</td></tr><tr><td align="center">ExtraVolumeMounts</td></tr><tr><td align="center">Tolerations</td></tr><tr><td align="center">DNSPolicy</td></tr><tr><td align="center">HTTPPort</td></tr><tr><td align="center">HTTPSPort</td></tr><tr><td align="center">PriorityClassName</td></tr><tr><td align="center">DefaultBackendConfig</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cloud-provider-support">Cloud Provider Support<a class="hash-link" href="#cloud-provider-support" title="Direct link to heading">​</a></h3><p>migration-agent is able to migrate cloud provider configuration, this happens by copying the rke1 config file to the rke2 configuration directory and then passes down flags to RKE2 to include the name and path of cloud provider config:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">```</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">--cloud-provider-config</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">--cloud-provider-name</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">```</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="private-registry-support">Private Registry Support<a class="hash-link" href="#private-registry-support" title="Direct link to heading">​</a></h3><p>The agent also adds the ability to migrate private registry configuration, this happens by copying the private registries configured in the cluster.yaml file in rke1. Unfortunately RKE1 lacks the feature of passing TLS configuration to private registries and depends on Docker TLS configuration manually on each node, so to account for that migration-agent supports a flag --registry which Configure private registry TLS paths, syntax should be <code>&lt;registry url&gt;,&lt;ca cert path&gt;,&lt;cert path&gt;,&lt;key path&gt;</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cni-configuration-migration">CNI Configuration Migration<a class="hash-link" href="#cni-configuration-migration" title="Direct link to heading">​</a></h3><p>RKE1 and RKE2 both support Calico and Canal CNI, so migration-agent will be able to migrate the CNI only if Canal or Calico is used.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/rancher/rke2-docs/edit/main/docs/migration.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vbeJ"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2022-10-04T15:59:21.000Z">10/4/2022</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introducing-migration-agent" class="table-of-contents__link toc-highlight">Introducing Migration Agent</a><ul><li><a href="#usage" class="table-of-contents__link toc-highlight">Usage</a></li><li><a href="#cluster-configuration" class="table-of-contents__link toc-highlight">Cluster Configuration</a></li><li><a href="#addons-migration" class="table-of-contents__link toc-highlight">Addons Migration</a></li><li><a href="#cluster-addons-configuration-migration" class="table-of-contents__link toc-highlight">Cluster Addons Configuration Migration</a></li><li><a href="#cloud-provider-support" class="table-of-contents__link toc-highlight">Cloud Provider Support</a></li><li><a href="#private-registry-support" class="table-of-contents__link toc-highlight">Private Registry Support</a></li><li><a href="#cni-configuration-migration" class="table-of-contents__link toc-highlight">CNI Configuration Migration</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 SUSE Rancher. All Rights Reserved.</div></div></div></footer></div>
<script src="/rke2-docs/assets/js/runtime~main.cc8464e9.js"></script>
<script src="/rke2-docs/assets/js/main.a8254415.js"></script>
</body>
</html>